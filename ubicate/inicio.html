<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Ubicate</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="src/mapa.css" />
  </head>
  <body>
    <!-- Navbar optimizado para móviles -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
      <div class="container-fluid">
        <!-- Logo -->
        <a class="navbar-brand" href="#">
          <img src="src/assets/Logo.jpeg" alt="Logo" class="logo-img" />
        </a>

        <!-- Título centrado -->
        <div class="navbar-title">Bienvenido</div>

        <!-- Botón de cuenta -->
        <button class="btn-with-img">
          <span class="d-none d-sm-inline"></span>
          <img src="src/assets/usuario.png" alt="Usuario" class="btn-img" />
        </button>
      </div>
    </nav>

    <!-- Barra de búsqueda -->
    <div class="search-container">
      <input
        type="text"
        id="direccion"
        class="input-direccion"
        placeholder="¿Qué buscas hoy?"
      />
      <button onclick="buscarDireccion()" class="search-btn">Buscar</button>
    </div>

    <!-- Mapa -->
    <div id="map" class="mapa"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Inicializar mapa
      const map = L.map("map").setView([13.4846, -88.1834], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
        maxZoom: 19,
      }).addTo(map);

      let marcador;

      // Obtener ubicación actual
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            map.setView([lat, lon], 15);

            // Icono personalizado
            const iconoPersona = L.icon({
              iconUrl: "src/assets/usuario.png",
              iconSize: [32, 32],
              iconAnchor: [16, 32],
              popupAnchor: [0, -32],
            });

            marcador = L.marker([lat, lon], { icon: iconoPersona })
              .addTo(map)
              .bindPopup("📍 Estás aquí")
              .openPopup();
          },
          (err) => {
            console.warn("No se pudo obtener ubicación:", err.message);
            // Marcador por defecto si no se obtiene ubicación
            marcador = L.marker([13.4846, -88.1834])
              .addTo(map)
              .bindPopup("📍 Ubicación por defecto")
              .openPopup();
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0,
          }
        );
      }

      // Buscar dirección
      function buscarDireccion() {
        const input = document.getElementById("direccion").value.trim();
        if (!input) {
          alert("Por favor, escribe una dirección para buscar.");
          return;
        }

        // Mostrar indicador de carga
        const btnBuscar = document.querySelector(".search-btn");
        btnBuscar.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Buscando...';
        btnBuscar.disabled = true;

        fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            input
          )}`
        )
          .then((res) => res.json())
          .then((data) => {
            if (data.length === 0) {
              alert("No se encontraron resultados para tu búsqueda.");
              return;
            }

            const lugar = data[0];
            const lat = parseFloat(lugar.lat);
            const lon = parseFloat(lugar.lon);

            map.setView([lat, lon], 15);

            if (marcador) map.removeLayer(marcador);

            marcador = L.marker([lat, lon])
              .addTo(map)
              .bindPopup(`📍 ${lugar.display_name}`)
              .openPopup();
          })
          .catch((err) => {
            console.error("Error al buscar dirección:", err);
            alert(
              "Ocurrió un error al buscar la dirección. Intenta nuevamente."
            );
          })
          .finally(() => {
            btnBuscar.innerHTML = "Buscar";
            btnBuscar.disabled = false;
          });
      }

      // Manejar el botón de búsqueda al presionar Enter
      document
        .getElementById("direccion")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            buscarDireccion();
          }
        });
    </script>
  </body>
</html>
